var Ue=Object.defineProperty;var Ve=(n,f,S)=>f in n?Ue(n,f,{enumerable:!0,configurable:!0,writable:!0,value:S}):n[f]=S;var B=(n,f,S)=>Ve(n,typeof f!="symbol"?f+"":f,S);(function(){"use strict";var n=typeof document<"u"?document.currentScript:null;webix.protoUI({name:"formtable",$allowsClear:!0,setValue:function(o){this.clearAll(),o&&this.parse(o)},getValue:function(){return this.serialize()}},webix.ui.datatable);function f(){let o="",e=2589;const t=document.getElementById("ApiServerIpPort");t!=null&&(e=t.value),o=`http://${window.location.hostname}:${e}/api`;var s=webix.ajax();webix.proxy.api={$proxy:!0,init:i=>{},load:(i,r)=>{if(o=="")return webix.message("Служба не настроена - не указан порт сервера api. Настройте и перезапустите ее."),[];i.disable();var a=i.config.url.source;return s.get(`${o}${a}`).then(l=>{var p=l.json();return p.isSuccess!=null&&(p.isSuccess||webix.message(p.message)),i.enable(),p.content},l=>{i.enable(),webix.message(l)})},save:(i,r)=>{if(o=="")return webix.message("Служба не настроена - не указан порт сервера api. Настройте и перезапустите ее."),[];i.disable(),i.config.url.source}}}class S{constructor(){this.currentPage="",this.routes=new Map}register(e,t){this.routes.set(e,t)}async navigate(e,t){if(e===this.currentPage)return;const s=this.routes.get(e);if(s)try{const i=await s();webix.ui(i(t),$$(t)),$$(t).show(),this.currentPage=e}catch(i){console.error("Ошибка при навигации:",i)}}}const D=o=>({container:"app",type:"space",id:"root",responsive:!0,...o}),O=o=>({view:"toolbar",padding:5,height:60,elements:[{view:"label",id:"toolbarLabel",label:o}]}),N=(o,e)=>({view:"sidebar",id:"sidebar",width:200,collapsed:!1,data:o,on:{onAfterSelect:e}}),R={MONITOR:{id:"monitorView",value:"Мониторинг"},CONFIG:{id:"config",value:"Настройка"},CDN:{id:"cdnListInfo",value:"Список CDN"},LOGS:{id:"logsView",value:"Логи"},INFO:{id:"information",value:"Информация"}},Fe="modulepreload",ze=function(o,e){return new URL(o,e).href},je={},h=function(e,t,s){let i=Promise.resolve();function r(a){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a}return i.then(a=>{for(const l of a||[])l.status==="rejected"&&r(l.reason);return e().catch(r)})};function v(o){const e=$$(o);let t=JSON.stringify(e.getValues());e.disable(),webix.ajax().post("api/configuration/parameters",t).then(s=>{let i=s.json();if(console.log(i),!i.isSuccess){webix.message(i);return}var r=i.needToRestart;r&&webix.message("Изменения будут применены после перезапуска службы DS:Fmu-Api (она произойдет в течение одной минуты)")}).finally(s=>{e.enable()})}const $={serverConfigData:()=>h(()=>Promise.resolve().then(()=>Z),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),salesControl:()=>h(()=>Promise.resolve().then(()=>J),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),minimalPrices:()=>h(()=>Promise.resolve().then(()=>te),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),organizationsTable:()=>h(()=>Promise.resolve().then(()=>se),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),pingHosts:()=>h(()=>Promise.resolve().then(()=>ae),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),databaseConnection:()=>h(()=>Promise.resolve().then(()=>Le),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),frontolDbConnection:()=>h(()=>Promise.resolve().then(()=>Ae),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),markUnit:()=>h(()=>Promise.resolve().then(()=>Te),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),tokenServiceData:()=>h(()=>Promise.resolve().then(()=>ve),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),timeoutConfig:()=>h(()=>Promise.resolve().then(()=>Be),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),loggingConfigData:()=>h(()=>Promise.resolve().then(()=>Ne),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href),autoUpdateData:()=>h(()=>Promise.resolve().then(()=>xe),void 0,n&&n.tagName.toUpperCase()==="SCRIPT"&&n.src||new URL("index.js",document.baseURI).href)};function k(o){$$("toolbarLabel").setValue("FMU-API: Настройка службы");let e=null,t=!1;return{id:o,view:"form",complexData:!0,hidden:!0,borderless:!0,rows:[{cols:[{id:"saveConfigurationButton",view:"button",value:"Сохранить",autowidth:!1,width:120,hidden:!0,click:function(){v(o)}},{}]},{id:"settingsScroll",view:"scrollview",scroll:"y",body:{rows:[]}}],on:{onViewShow:async function(){t=!0;const s=$$(o),i=$$("settingsScroll").getBody();webix.extend($$(o),webix.ProgressBar);try{s.showProgress({type:"icon"}),e=new AbortController;const r=await webix.ajax().get("api/configuration/parameters",{signal:e.signal});if(!t)return;const a=r.json().content;for(const l of Object.keys($)){const E=(await $[l]()).default(l,a);i.addView(E)}$$("saveConfigurationButton").show()}catch(r){if(r.name==="AbortError"){console.log("Загрузка настроек отменена");return}t&&webix.message({type:"error",text:"Ошибка загрузки настроек"}),console.error("Ошибка загрузки настроек:",r)}finally{t&&s.hideProgress()}},onDestruct:function(){e&&(e.abort(),e=null)}}}}function _(o=""){let e=document.getElementById("ApiServerIpPort");if(e==null)return"";let t=e.value;return`http://${window.location.hostname}:${t}/api${o}`}function x(o){return $$("toolbarLabel").setValue("FMU-API: Информация о системе"),{id:o,rows:[{view:"form",on:{onViewShow:M()},elements:[{view:"label",id:"appVersion",label:"Версия загружается..."},{view:"label",id:"lDatabaseEngineInfo",label:'Для работы fmu-api необходимо скачать и установить базу данных <a href="https://couchdb.apache.org" target="_blank" style="color: red">Apache CouchDb.</a>'},{view:"label",id:"browserRecommendation",label:"Для работы рекомендуется использовать браузер Vivaldi, Edge, Opera, Chrome - в общем все на базе Chromium."},{view:"label",id:"swaggerLink",label:'<a href="scalar/v1" target="_blank" style="color: red">Консоль запросов swagger.</a>.'},{}]}]}}function M(){webix.ajax().get(_("/configuration/about")).then(function(o){var e=o.text();$$("appVersion").setValue(e)})}function y(o){return $$("toolbarLabel").setValue("FMU-API: Список cdn-серверов"),{view:"datatable",id:o,columns:[{id:"host",header:"Хост",fillspace:!0},{id:"latency",header:"Задержка"},{id:"offline",header:"Оффлайн"}],scroll:!1,on:{onBeforeLoad:function(){this.showOverlay("Загружаю...")},onAfterLoad:function(){this.hideOverlay()}},url:function(e){return webix.ajax(_("/configuration/cdn"))}}}class U{constructor(e){this.formName="LogsView",this.id=e,this.LABELS={formTitle:"FMU-API: Логи работы",title:"Просмотр логов",logFile:"Лог работы:",refresh:"Обновить",save:"Сохранить",downloadAll:"Выгрузить все логи",close:"Закрыть",fileDescription:"Текстовый файл",errorDownload:"Ошибка при выгрузке логов",errorLoad:"Ошибка при загрузке логов"},this.NAMES={toolbarLabel:"toolbarLabel",logFiles:"logFiles",refreshLogBtn:"refreshLogBtn",uploadLogBtn:"uploadLogBtn",log:"log"}}render(){$$(this.NAMES.toolbarLabel).setValue(this.LABELS.formTitle);var e=[this._logToolbar(),this._logTextArea()],t={view:"form",id:this.id,name:this.formName,disabled:!0,on:{onViewShow:this._loadLogs("",this.id)},elements:e};return t}_logToolbar(){return{cols:[this._logsCombo(),this._refreshButton(),this._uploadLogButton()]}}_logsCombo(){return{view:"combo",id:this.NAMES.logFiles,label:this.LABELS.logFile,labelWidth:100,newvalues:!1,options:[],on:{onChange:e=>{this._loadLogs(e,this.id)}}}}_refreshButton(){return{view:"button",value:this.LABELS.refresh,id:this.NAMES.refreshLogBtn,autowidth:"false",width:400,click:async e=>{var t=$$(this.NAMES.logFiles),s=t.getValue();s&&s!=""&&this._loadLogs(s,this.id)}}}_uploadLogButton(){return{view:"button",value:this.LABELS.save,id:this.NAMES.uploadLogBtn,autowidth:"false",width:400,click:async e=>{var t=$$(this.NAMES.log),s=await this._getNewFileHandle();await this._writeTextFile(s,t.getValue())}}}_logTextArea(){return{view:"textarea",id:this.NAMES.log,readonly:!0}}_loadLogs(e,t){$$(t).disable(),e=e.length==0?"now":e,webix.ajax().get(_(`/configuration/logs/${e}`)).then(s=>{var i=s.json(),r=$$(this.NAMES.logFiles);r.blockEvent();var a=r.getPopup().getList();a.clearAll(),a.parse(i.fileNames),r.setValue(i.selectedFile),r.unblockEvent();var l=$$(this.NAMES.log);const p=i.log.split(`
`).reverse().join(`
`);l.setValue(p),$$(t).enable()})}async _getNewFileHandle(){const e={types:[{keepExistingData:!1,description:"Текстовый файл",accept:{"text/plain":[".txt"]}}]};return await window.showSaveFilePicker(e)}async _writeTextFile(e,t){const s=await e.createWritable(),i=t.split(`
`).reverse().join(`
`);await s.write(i),await s.close()}}function V(o){return new U(o).render()}class F{constructor(e){this.formName="MonitorView",this.id=e,this.monitoringApiAddress="/api/monitoring/systemstate",this.POLL_INTERVAL=1e4,this.LABELS={formTitle:"FMU-API: Мониторинг",dbStatus:"Статус базы данных: ",dbStatusOnline:"Online",dbStatusOffline:"Offline",dbStatusUnknown:"Неизвестно",localModules:"Локальные модули",lastSync:"Последняя синхронизация",version:"Версия",status:"Статус",url:"Адрес модуля"},this.NAMES={toolbarLabel:"toolbarLabel",dbStatus:"dbStatus",localModulesTable:"localModulesTable"},this._startLocalMonitoringPolling()}loadConfig(){return this.CouchDbOnLine=!1,this}render(){$$("toolbarLabel").setValue(this.LABELS.formTitle);var e=[{view:"label",id:"dbStatus",label:this.LABELS.dbStatus+this.LABELS.dbStatusUnknown},{view:"label",label:this.LABELS.localModules},this._localModules(),{}],t={view:"form",id:this.id,name:this.formName,disabled:!1,elements:e};return t}_localModules(){return{id:this.NAMES.localModulesTable,view:"datatable",columns:[{id:"url",header:this.LABELS.url,fillspace:!0,sort:"string"},{id:"version",header:this.LABELS.version,width:150,sort:"string"},{id:"lastSyncDateTime",header:this.LABELS.lastSync,width:300,sort:"date",format:function(e){const t=new Date(e);return t.getFullYear()<=1970?"Нет данных":t.toLocaleString()}},{id:"status",header:this.LABELS.status,width:120,sort:"string",template:function(e){var t=e.isReady?"#00BFFF":"#ff0000";return`<span style="color: ${t};">${e.status||"Нет данных"}</span>`}}],autoheight:!0,scroll:!1,select:!1,data:[]}}_startLocalMonitoringPolling(){const e=this.POLL_INTERVAL,t=async()=>{try{const i=await fetch(this.monitoringApiAddress);if(!i.ok)throw new Error(`Ошибка получения данных мониторинга ${i.status}`);const r=await i.json();this._updateDbState(r.couchDbOnLine),this._updateLocalModulesInformation(r.localeModulesInformation)}catch(i){console.error("Ошибка при получении данных о состоянии сервиса:",i)}};t();const s=setInterval(t,e);this.on_destroy=()=>{clearInterval(s)}}_updateDbState(e){const t=$$(this.NAMES.dbStatus);t&&t.setValue(this.LABELS.dbStatus+(e?`<span style="color: #00BFFF;">${this.LABELS.dbStatusOnline}</span>`:`<span style="color: #ff0000;">${this.LABELS.dbStatusOffline}</span>`))}_updateLocalModulesInformation(e){if(!e)return;const t=$$(this.NAMES.localModulesTable);if(!t)return;const s=Object.entries(e).map(([i,r])=>({id:i,url:i,version:r.version||"Нет данных",status:r.status||"Нет данных",lastSyncDateTime:r.lastSyncDateTime,isReady:r.isReady,hasSyncError:r.hasSyncError}));t.clearAll(),t.parse(s)}}function z(o){return new F(o).loadConfig().render()}class j{constructor(){this.router=new S,this.bodyId="body",this.initRoutes()}initRoutes(){this.router.register("config",()=>k),this.router.register("information",()=>x),this.router.register("cdnListInfo",()=>y),this.router.register("logsView",()=>V),this.router.register("monitorView",()=>z)}createMainLayout(){return D({rows:[O("FMU-API"),{cols:[N(Object.values(R),e=>this.router.navigate(e,this.bodyId)),{id:this.bodyId}]}]})}init(){f(),webix.ready(()=>{webix.ui(this.createMainLayout()),this.router.navigate("monitorView","body"),webix.event(window,"resize",()=>{const e=$$("root");$$(this.bodyId),e.$setSize(window.innerWidth,window.innerHeight)})})}}new j().init();function T(o){let e=$$(o);if(e==null)return;let t=e.data.tableId;if(t!=null)return $$(t)}function G(o){let e=T(o);e!=null&&webix.confirm({title:"Вы уверены?",text:"Вы собираетесь полностью очистить таблицу?",ok:"Да",cancel:"Нет"}).then(function(){e.clearAll(),$$(o).disable()})}function H(o,e){let t=T(o);if(t==null)return;let s=t.getSelectedItem();if(s==null){webix.message("Не выбрана строка для удаления!");return}t.remove(s.id)}function W(o,e){let t=T(o);t!=null&&t.add({})}const c={top:5,bottom:5,left:20,right:20};function P(o,e={}){let t={cols:[{view:"button",value:"Добавить",id:`add_${o}`,tableId:o,autowidth:"false",width:400,click:W},{view:"button",value:"Удалить",id:`delete_${o}`,tableId:o,autowidth:"false",width:400,disabled:!0,click:H},{view:"button",value:"Удалить все",id:`deleteAll_${o}`,tableId:o,autowidth:"false",width:400,disabled:!1,click:G},{}]};return L(t,e)}function d(o,e,t={}){return L({view:"label",id:o,label:e},t)}function u(o,e,t,s={}){return L({view:"text",type:"text",value:t,label:o,labelPosition:"top",id:e,name:e},s)}function b(o,e,t,s,i={}){return L({view:"text",type:"number",id:e,name:e,value:t,label:o,labelPosition:"top",format:s},i)}function A(o,e,t={}){return L({view:"text",type:"password",label:o,labelPosition:"top",id:e,name:e},t)}function m(o,e,t={}){return L({view:"checkbox",label:o,labelWidth:"auto",labelPosition:"left",id:e,name:e},t)}function L(o,e){for(let t in e)o[t]=e[t];return o}class q{constructor(e){this.id=e,this.LABELS={title:"Сервер",name:"Название узла",ipPortApi:"IP-порт API сервиса"}}loadConfig(e){return e!=null&&e.serverConfig&&(this.apiIpPort=e.serverConfig.apiIpPort??2578),e!=null&&e.nodeName&&(this.nodeName=e.nodeName),this}render(){var e=[];return e.push(d("lServerConfig",this.LABELS.title)),e.push({padding:c,rows:[u("Название узла","nodeName",this.nodeName),b("IP-порт API сервиса","serverConfig.apiIpPort",this.apiIpPort,"111")]}),{id:this.id,rows:e}}}function Y(o,e){return new q(o).loadConfig(e).render()}const Z=Object.freeze(Object.defineProperty({__proto__:null,default:Y},Symbol.toStringTag,{value:"Module"}));class K{constructor(e){this.id=e,this.SETTINGS_ID="saleControlls",this.LABELS={title:"Контроль при продаже товаров",banSalesReturnedWares:"Блокировать продажу возвращенных товаров",ignoreVerificationErrorForTrueApiGroups:"Коды групп товаров игнорирующик проверку статусов кода маркировки в Честном Знаке",checkIsOwnerField:"Проверять владельца марки",forFrontolMoreThen205:"Настройки для тарифного фронтола (6.21.0 и выше):",checkReceiptReturn:"Проверять товары из чеков возврата",sendEmptyTrueApiAnswerWhenTimeoutError:"Генерировать пустой ответ от честного знака при недоступности cdn",correctExpireDateInReturns:"Исправлять истекший срок годности в чеках возврата",sendLocalModuleInformationalInRequestId:"Отправлять информацию о локальном модуле для тега 1265 в requestId",dateRejectsSalesWithoutCheckData:"Дата отказа в продаже данных проверки (оффлайн режим)",resetSoldStatusForReturn:"Для возвратов - изменять стаус `Проданно` для товаров (тарифный фронтол до 25 версии)"}}loadConfig(e){return e!=null&&e.saleControlConfig&&(this.banSalesReturnedWares=e.saleControlConfig.banSalesReturnedWares,this.ignoreVerificationErrorForTrueApiGroups=e.saleControlConfig.ignoreVerificationErrorForTrueApiGroups,this.checkIsOwnerField=e.saleControlConfig.checkIsOwnerField,this.checkReceiptReturn=e.saleControlConfig.checkReceiptReturn,this.sendEmptyTrueApiAnswerWhenTimeoutError=e.saleControlConfig.sendEmptyTrueApiAnswerWhenTimeoutError,this.correctExpireDateInSaleReturn=e.saleControlConfig.correctExpireDateInSaleReturn,this.sendLocalModuleInformationalInRequestId=e.saleControlConfig.sendLocalModuleInformationalInRequestId,this.rejectSalesWithoutCheckInformationFrom=new Date(e.saleControlConfig.rejectSalesWithoutCheckInformationFrom),this.resetSoldStatusForReturn=e.saleControlConfig.resetSoldStatusForReturn),this}render(){var e=[];return e.push(d("lSalesControlParameters",this.LABELS.title)),e.push({padding:c,rows:[{view:"datepicker",label:this.LABELS.dateRejectsSalesWithoutCheckData,name:"saleControlConfig.rejectSalesWithoutCheckInformationFrom",value:this.rejectSalesWithoutCheckInformationFrom,labelPosition:"top",format:"%Y-%m-%d"},m(this.LABELS.banSalesReturnedWares,"saleControlConfig.banSalesReturnedWares",{value:this.banSalesReturnedWares}),u(this.LABELS.ignoreVerificationErrorForTrueApiGroups,"saleControlConfig.ignoreVerificationErrorForTrueApiGroups",this.ignoreVerificationErrorForTrueApiGroups),m(this.LABELS.checkIsOwnerField,"saleControlConfig.checkIsOwnerField",{value:this.checkIsOwnerField}),m(this.LABELS.correctExpireDateInReturns,"saleControlConfig.correctExpireDateInSaleReturn",{value:this.correctExpireDateInSaleReturn}),m(this.LABELS.sendLocalModuleInformationalInRequestId,"saleControlConfig.sendLocalModuleInformationalInRequestId",{value:this.sendLocalModuleInformationalInRequestId}),d("scForFrontolMoreThen21",this.LABELS.forFrontolMoreThen205),{padding:{left:20},rows:[m(this.LABELS.checkReceiptReturn,"saleControlConfig.checkReceiptReturn",{value:this.checkReceiptReturn}),m(this.LABELS.sendEmptyTrueApiAnswerWhenTimeoutError,"saleControlConfig.sendEmptyTrueApiAnswerWhenTimeoutError",{value:this.sendEmptyTrueApiAnswerWhenTimeoutError}),m(this.LABELS.resetSoldStatusForReturn,"saleControlConfig.resetSoldStatusForReturn",{value:this.resetSoldStatusForReturn})]}]}),{id:this.id,rows:e}}}function X(o,e){return new K(o).loadConfig(e).render()}const J=Object.freeze(Object.defineProperty({__proto__:null,default:X},Symbol.toStringTag,{value:"Module"}));class Q{constructor(e){this.id=e,this.SETTINGS_ID="minimalPrices",this.LABELS={title:"Минимальные цены",tabaco:"Табак (в копейках 135р = 13500)"}}loadConfig(e){return e!=null&&e.saleControlConfig&&(this.tabaco=e.minimalPrices.tabaco),this}render(){var e=[];return e.push(d("lMinimalPrices",this.LABELS.title)),e.push({padding:c,rows:[b(this.LABELS.tabaco,"minimalPrices.tabaco",this.tabaco,"1111")]}),{id:this.id,rows:e}}}function ee(o,e){return new Q(o).loadConfig(e).render()}const te=Object.freeze(Object.defineProperty({__proto__:null,default:ee},Symbol.toStringTag,{value:"Module"}));class oe{constructor(e){this.id=e,this.formName="OrganisationForm",this.LABELS={title:"Организации",newOrg:"Новая организация",editOrg:"Организация",code:"Код организации (группы печати), если группы печати не используются, то все равно код должен быть 1",inn:"ИНН организации",name:"Наименование",xapikey:"X-API key",add:"Сохранить",close:"Закрыть",enable:"Используется",connectionAddress:"Адрес подключения",userName:"Имя пользователя",password:"Пароль",localModuleStatus:"Статус ЛМ",LocalModuleTitle:"Локальный модуль Честного знака",localModuleStatusTitle:"Статус локального модуля",localModuleInit:"Инициализация ЛМ"},this.LOCAL_MODULE_STATUS={NOT_CONFIGURED:0,INITIALIZATION:1,READY:2,SYNC_ERROR:3,UNKNOWN:4},this.LOCAL_MODULE_STATUS_DISPLAY={[this.LOCAL_MODULE_STATUS.NOT_CONFIGURED]:{text:"Не настроен",color:"#FFA500"},[this.LOCAL_MODULE_STATUS.INITIALIZATION]:{text:"Инициализация",color:"#3498DB"},[this.LOCAL_MODULE_STATUS.READY]:{text:"Готов к работе",color:"#2ECC71"},[this.LOCAL_MODULE_STATUS.SYNC_ERROR]:{text:"Ошибка синхронизации",color:"#E74C3C"},[this.LOCAL_MODULE_STATUS.UNKNOWN]:{text:"Неизвестный статус",color:"#E74C3C"}},this.POLL_INTERVAL=1e4,this._startLocalModuleStatusPolling()}_getStatusDisplay(e){return this.LOCAL_MODULE_STATUS_DISPLAY[e]||{text:"Неизвестный статус",color:"#95A5A6"}}loadConfig(e){return e&&e.organisationConfig&&e.organisationConfig.printGroups&&(this.printGroups=e.organisationConfig.printGroups.map(t=>({...t,localModuleStatus:this.LOCAL_MODULE_STATUS.NOT_CONFIGURED}))),this}render(){var e=[];e.push(d("lOrganizations",this.LABELS.title));const t=P("PrintGroups");return t.cols.splice(t.cols.length-1,0,{view:"button",value:this.LABELS.localModuleInit,id:"initLm_PrintGroups",disabled:!0,tableId:"PrintGroups",autowidth:!1,width:200,tooltip:"Инициализация локального модуля",click:()=>this._initializeLocalModule()}),e.push({padding:c,name:"organisationConfig",rows:[t,this._createFormTable()]}),{id:this.id,rows:e}}_createFormTable(){return{view:"formtable",id:"PrintGroups",name:"organisationConfig.printGroups",data:this.printGroups,resizeColumn:!0,resizeRow:!0,select:!0,minHeight:250,columns:[{id:"id",header:this.LABELS.code},{id:"name",header:this.LABELS.name,fillspace:!0},{id:"xapikey",header:this.LABELS.xapikey,fillspace:!0},{id:"localModuleStatus",header:this.LABELS.localModuleStatusTitle,fillspace:!0,template:e=>{const t=this._getStatusDisplay(e.localModuleStatus);return`<div style="
                            color: ${t.color}; 
                            font-weight: bold; 
                            text-align: center;
                            padding: 2px 5px;
                            border-radius: 3px;
                            background: ${t.color}15;
                        ">
                            ${t.text}
                        </div>`}}],on:{onAfterSelect:e=>{$$("delete_PrintGroups").enable(),this._updateInitButtonState()},onAfterDelete:e=>{$$("delete_PrintGroups").disable(),$$("PrintGroups").count()==0&&$$("deleteAll_PrintGroups").disable()},onBeforeAdd:(e,t)=>{if(t.xapikey==null)return this.showForm(this.LABELS.newOrg,"PrintGroups"),!1},onItemDblClick:e=>{this.showForm(this.LABELS.editOrg,"PrintGroups",e)}}}}showForm(e,t,s){const i=window.innerWidth;webix.ui({view:"window",id:this.formName,position:"center",modal:!0,move:!1,resize:!1,width:i*.8,head:this._createFormHeader(e),body:this._createFormBody(t,s)}).show(),this._initFormValues(t,s)}_createFormHeader(e){return{view:"toolbar",elements:[{view:"label",label:e},{view:"icon",icon:"wxi-close",click:()=>$$(this.formName).close()}]}}_createFormBody(e,t){return{padding:10,rows:[b(this.LABELS.code,"OrganizationId","1111"),u(this.LABELS.name,"OrganizationName"),u(this.LABELS.inn,"OrganizationInn"),u(this.LABELS.xapikey,"XAPIKEY"),d("LocalModuleTitle",this.LABELS.LocalModuleTitle),m(this.LABELS.enable,"LocalModuleEnable"),u(this.LABELS.connectionAddress,"LocalModuleConnectionAddress","",{placeholder:"http://hostname:5995"}),u(this.LABELS.userName,"LocalModuleUserName"),A(this.LABELS.password,"LocalModulePassword"),{padding:{top:10},cols:[{view:"button",value:this.LABELS.add,id:"addButton",autowidth:"false",width:400,click:()=>this._handleAddButton(e,t)},{view:"button",value:this.LABELS.close,id:"closeBtn",autowidth:"false",width:400,click:()=>$$(this.formName).close()},{}]}]}}_handleAddButton(e,t){let s=$$("OrganizationId").getValue();if(s=="")return;let i=$$(e);if(i==null)return;if(i.find(l=>l.id==s&&s!=t).length>0){webix.message({text:"Организация с таким кодом уже есть в списке!",type:"error"});return}const a={id:s,xapikey:$$("XAPIKEY").getValue(),inn:$$("OrganizationInn").getValue(),name:$$("OrganizationName").getValue(),localModuleConnection:{enable:$$("LocalModuleEnable").getValue(),connectionAddress:$$("LocalModuleConnectionAddress").getValue(),userName:$$("LocalModuleUserName").getValue(),password:$$("LocalModulePassword").getValue()}};t==null?i.add(a):i.updateItem(t,a),i.count()>0&&$$("deleteAll_PrintGroups").enable(),$$(this.formName).close(),this._saveConfiguration(),this._updateInitButtonState()}_saveConfiguration(){v("body")}_initFormValues(e,t){let s=$$(e);if(t==null){let r=s.getLastId();$$("OrganizationId").setValue(r==null?1:r+1);return}let i=s.getItem(t);$$("OrganizationId").setValue(i.id),$$("OrganizationId").disable(),$$("OrganizationInn").setValue(i.inn),$$("OrganizationName").setValue(i.name),$$("LocalModuleEnable").setValue(i.localModuleConnection.enable),$$("LocalModuleConnectionAddress").setValue(i.localModuleConnection.connectionAddress),$$("LocalModuleUserName").setValue(i.localModuleConnection.userName),$$("LocalModulePassword").setValue(i.localModuleConnection.password),$$("XAPIKEY").setValue(i.xapikey)}_startLocalModuleStatusPolling(){const e=this.POLL_INTERVAL,t=async()=>{try{const i=await fetch("/api/lm/state");if(!i.ok)throw new Error("Ошибка получения статусов");const r=await i.json(),a=$$("PrintGroups");if(!a)return;r.forEach(l=>{const p=a.getItem(l.organization);if(p){if(p.localModuleStatus==l.status)return;const E={...p,localModuleStatus:l.status};a.updateItem(l.organization,E),this._updateInitButtonState()}})}catch(i){console.error("Ошибка при получении статусов ЛМ:",i)}};t();const s=setInterval(t,e);this.on_destroy=()=>{clearInterval(s)}}_updateInitButtonState(){const e=$$("PrintGroups").getSelectedId(),t=$$("initLm_PrintGroups");if(!e||!t)return;const i=$$("PrintGroups").getItem(e).localModuleConnection;i.enable&&i.connectionAddress&&i.userName&&i.password?t.enable():t.disable()}_initializeLocalModule(){const e=$$("PrintGroups").getSelectedId();if(!e){webix.message({text:"Выберите организацию для инициализации локального модуля",type:"warning"});return}const s=$$("PrintGroups").getItem(e);if(s.localModuleConnection.enable){if(s.localModuleStatus===this.LOCAL_MODULE_STATUS.NOT_CONFIGURED){this._startInitialization(e,s);return}if(s.localModuleStatus!=this.LOCAL_MODULE_STATUS.READY){webix.message({text:`В этом статусе ЛМ ${this.LOCAL_MODULE_STATUS_DISPLAY[s.localModuleStatus].text} нельзя выполнять инициализацию!`,type:"warning"});return}webix.confirm({title:"Инициализация локального модуля",text:`Выполнить повторную инициализацию локального модуля для организации "${s.name}"?`,ok:"Да",cancel:"Отмена",callback:i=>{i&&this._startInitialization(e,s)}})}}_startInitialization(e,t){const s=$$("PrintGroups"),i={...t,localModuleStatus:this.LOCAL_MODULE_STATUS.INITIALIZATION};s.updateItem(e,i),fetch(`/api/lm/init/${e}`,{method:"POST"}).catch(r=>{console.error("Ошибка при отправке запроса инициализации:",r),webix.message({text:"Ошибка при отправке запроса инициализации",type:"error"})}),webix.message({text:"Запущена инициализация локального модуля",type:"info"})}}function ie(o,e){return new oe(o).loadConfig(e).render()}const se=Object.freeze(Object.defineProperty({__proto__:null,default:ie},Symbol.toStringTag,{value:"Module"}));class ne{constructor(e){this.id=e,this.formName="HostToPingForm",this.LABELS={title:"Адреса сайтов для проверки доступности интернета (если проверка не нужна, то список должен быть пустым)",newHost:"Новый сайт",editHost:"Сайт",hostNameHint:"название сайта без https, например: au124.ru",add:"Сохранить",close:"Закрыть",existError:"Этот сайт уже есть в списке!"}}loadConfig(e){return e&&e.hostsToPing&&(this.hostsToPing=e.hostsToPing),this}render(){var e=[];return e.push(d("lHostsToPing",this.LABELS.title)),e.push({padding:c,rows:[P("HostsToPing"),this._createFormTable()]}),{id:this.id,rows:e}}_createFormTable(){return{view:"formtable",id:"HostsToPing",name:"hostsToPing",data:this.hostsToPing,resizeColumn:!0,resizeRow:!0,select:!0,minHeight:250,columns:[{id:"id",header:"Код",hidden:!0},{id:"value",header:"Хост",fillspace:!0}],on:{onAfterSelect:()=>{$$("delete_HostsToPing").enable()},onAfterDelete:()=>{$$("delete_HostsToPing").disable(),$$("HostsToPing").count()==0&&$$("deleteAll_HostsToPing").disable()},onBeforeAdd:(e,t)=>{if(t.value==null)return this.showForm(this.LABELS.newHost,"HostsToPing"),!1},onItemDblClick:e=>{this.showForm(this.LABELS.editHost,"HostsToPing",e)}}}}showForm(e,t,s){const i=window.innerWidth;webix.ui({view:"window",id:this.formName,position:"center",modal:!0,move:!1,resize:!1,width:i*.8,head:this._createFormHeader(e),body:this._createFormBody(t,s)}).show(),this._initFormValues(t,s),$$("HostName").focus()}_createFormHeader(e){return{view:"toolbar",elements:[{view:"label",label:e},{view:"icon",icon:"wxi-close",click:()=>$$(this.formName).close()}]}}_createFormBody(e,t){return{rows:[u(this.LABELS.hostNameHint,"HostName",""),b("id hidden","Id","","1111",{hidden:!0}),{cols:[{view:"button",value:this.LABELS.add,id:"addButton",autowidth:"false",width:400,click:()=>this._handleAddButton(e,t)},{view:"button",value:this.LABELS.close,id:"closeBtn",autowidth:"false",width:400,click:()=>$$(this.formName).close()},{}]}]}}_handleAddButton(e,t){let s=$$("HostName").getValue();if(!s)return;let i=$$(e);if(!i)return;if(i.find(a=>a.value.toLowerCase()==s&&a.id!=t).length>0){webix.message({text:this.LABELS.existError,type:"error"});return}if(t==null){let a=i.getLastId(),l=a==null?1:a+1;i.add({value:s,id:l})}else i.updateItem(t,{value:s,id:t});i.count()>0&&$$("deleteAll_HostsToPing").enable(),$$(this.formName).close()}_initFormValues(e,t){if(t!=null){let i=$$(e).getItem(t);$$("HostName").setValue(i.value),$$("Id").setValue(i.id)}}}function re(o,e){return new ne(o).loadConfig(e).render()}const ae=Object.freeze(Object.defineProperty({__proto__:null,default:re},Symbol.toStringTag,{value:"Module"})),g={WINDOWS_PATH:"windowsPath",HTTP_ADDRESS:"httpAddress",HOSTNAME:"hostname",COUCH_DB:"couchDb",FRONTOL_DB:"frontolDb"};class le{constructor(e,t,s){this.type=e,this.validate=i=>i==null?!1:t(String(i)),this.message=s}toWebix(){return{validate:this.validate,invalidMessage:this.message,on:{onBlur:function(){this.validate()}}}}}const w=(o,e,t)=>new le(o,e,t),de=w(g.WINDOWS_PATH,o=>!o||o.length>260?!1:/^([a-zA-Z]:\\[^<>:"/\\|?*]+\\?)$|^(\\\\[^<>:"/\\|?*]+\\[^<>:"/\\|?*]+\\?)$/.test(o),"Введите корректный путь к каталогу Windows"),ue=w(g.HTTP_ADDRESS,o=>o==""?!0:!o||o.length>2083?!1:/^https?:\/\/[a-zA-Z0-9.-]+(?::\d+)?(?:\/[^?#]*)?(?:\?[^#]*)?(?:#.*)?$/.test(o),"Адрес должен быть в формате http(s)://hostname[:port]"),ce=w(g.FRONTOL_DB,o=>{if(o=="")return!0;let e=o.indexOf(":");if(e===-1)return!1;let t=o.substring(0,e),s=o.substring(e+1);if(/^\d+:/.test(s)){let i=s.indexOf(":"),r=s.substring(0,i);if(s=s.substring(i+1),!/^\d+$/.test(r))return!1}return!t||/[\\/:*?"<>|]/.test(t)?!1:s.startsWith("/")?s.length>1:/^[A-Za-z]:\\/.test(s)?!0:/^[^\\/:*?"<>|]+$/.test(s)},"Путь должен быть указан как 'ИМЯ_СЕРВЕРА:ПУТЬ_К_БАЗЕ_НА_СЕРВЕРЕ'"),he=w(g.COUCH_DB,o=>o==""?!0:/^[a-z][a-z0-9_$()+-/]*$/.test(o),"Допустимы только строчные латинские буквы, цифры и символы _$()+-/"),me=w(g.HOSTNAME,o=>o==""?!0:/^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/.test(o),"Адрес должен быть в формате domain.tld (например: au124.ru)"),pe=de.toWebix(),I=ue.toWebix(),be=ce.toWebix(),C=he.toWebix();me.toWebix();class fe{constructor(e){this.id=e,this.SETTINGS_ID="databaseConnection",this.LABELS={title:"База данных",enable:"Использовать",serverDbAddress:"Адрес сервера CouchDb",user:"Пользователь",password:"Пароль",dbMarks:"База данных марок",dbCashDocs:"База документов кассы",dbAlcoStamps:"База марок алкоголя",bulkBatchSize:"Размер пакета",bulkParallelTasks:"Количество параллельных задач",bulkLabel:"Параметры пакетной обработки"}}loadConfig(e){return e!=null&&e.logging&&(this.serverDbAddress=e.database.netAddress,this.userName=e.database.userName,this.userPassword=e.database.password,this.marksStateDbName=e.database.marksStateDbName,this.frontolDocumentsDbName=e.database.frontolDocumentsDbName,this.alcoStampsDbName=e.database.alcoStampsDbName,this.enable=e.database.enable,this.bulkBatchSize=e.database.bulkBatchSize,this.bulkParallelTasks=e.database.bulkParallelTasks),this}render(){var e=[];return e.push(d("lDatabaseConfig",this.LABELS.title)),e.push({padding:c,rows:[m(this.LABELS.enable,"database.enable",{value:this.enable,on:{onChange:t=>{t?$$(this.SETTINGS_ID).enable():$$(this.SETTINGS_ID).disable()}}}),{id:this.SETTINGS_ID,disabled:!this.enable,rows:[u(this.LABELS.serverDbAddress,"database.netAddress",this.serverDbAddress,I),{cols:[u(this.LABELS.user,"database.userName",this.userName),A(this.LABELS.password,"database.password",{value:this.userPassword})]},u(this.LABELS.dbMarks,"database.marksStateDbName",this.marksStateDbName,C),u(this.LABELS.dbCashDocs,"database.frontolDocumentsDbName",this.frontolDocumentsDbName,C),u(this.LABELS.dbAlcoStamps,"database.alcoStampsDbName",this.alcoStampsDbName,C),d("lBulkConfig",this.LABELS.bulkLabel),{padding:c,cols:[b(this.LABELS.bulkBatchSize,"database.bulkBatchSize",this.bulkBatchSize),b(this.LABELS.bulkParallelTasks,"database.bulkParallelTasks",this.bulkParallelTasks)]}]}]}),e.push({view:"button",id:"fauxton_open",value:"Открыть Fauxton",inputWidth:180,inputHeight:40,click:t=>{let s=$$("database.netAddress").getValue();s!=""&&window.open(`${s}/_utils`,"_blank").focus()}}),{id:this.id,rows:e}}}function Se(o,e){return new fe(o).loadConfig(e).render()}const Le=Object.freeze(Object.defineProperty({__proto__:null,default:Se},Symbol.toStringTag,{value:"Module"}));class ge{constructor(e){this.id=e,this.SETTINGS_ID="frontolDatabaseConnection",this.LABELS={title:"Настройка подключения к базе Frontol (для получения группы печати)",maingdbPath:"Путь к файлу main.gdb",user:"Имя пользователя firebird",password:"Пароль пользователя firebird"}}loadConfig(e){return e!=null&&e.frontolAlcoUnit&&(this.maingdbPath=e.frontolConnectionSettings.path,this.user=e.frontolConnectionSettings.userName,this.password=e.frontolConnectionSettings.password),this}render(){var e=[];return e.push(d("lFrontolConnection",this.LABELS.title)),e.push({padding:c,rows:[u(this.LABELS.maingdbPath,"frontolConnectionSettings.path",this.maingdbPath,be),u(this.LABELS.user,"frontolConnectionSettings.UserName",this.user,{placeholder:"SYSDBA"}),A(this.LABELS.password,"frontolConnectionSettings.password",{value:this.password})]}),{id:this.id,rows:e}}}function we(o,e){return new ge(o).loadConfig(e).render()}const Ae=Object.freeze(Object.defineProperty({__proto__:null,default:we},Symbol.toStringTag,{value:"Module"}));class Ee{constructor(e){this.id=e,this.SETTINGS_ID="markUnitConnection",this.LABELS={title:"Настройка подключения к MarkUnit",addres:"Адрес",user:"Имя пользователя",password:"Пароль"}}loadConfig(e){return e!=null&&e.frontolAlcoUnit&&(this.addres=e.frontolAlcoUnit.netAdres,this.user=e.frontolAlcoUnit.userName,this.password=e.frontolAlcoUnit.password),this}render(){var e=[];return e.push(d("lMarkUnit",this.LABELS.title)),e.push({padding:c,rows:[u(this.LABELS.addres,"frontolAlcoUnit.netAdres",this.addres,I),u(this.LABELS.user,"frontolAlcoUnit.UserName",this.user),A(this.LABELS.password,"frontolAlcoUnit.password",{value:this.password})]}),{id:this.id,rows:e}}}function _e(o,e){return new Ee(o).loadConfig(e).render()}const Te=Object.freeze(Object.defineProperty({__proto__:null,default:_e},Symbol.toStringTag,{value:"Module"}));class Ie{constructor(e){this.id=e,this.SETTINGS_ID="tokenService",this.LABELS={title:"Сервис получения токена для авторизации в Честном знаке",address:"Адрес",enable:"Использовать"}}loadConfig(e){return e!=null&&e.trueSignTokenService&&(this.address=e.trueSignTokenService.connectionAddress,this.enable=e.trueSignTokenService.enable),this}render(){var e=[];return e.push(d("lTrueSignService",this.LABELS.title)),e.push({padding:c,rows:[m(this.LABELS.enable,"trueSignTokenService.enable",{value:this.enable,on:{onChange:t=>{t?$$(this.SETTINGS_ID).enable():$$(this.SETTINGS_ID).disable()}}}),{id:this.SETTINGS_ID,disabled:!this.enable,rows:[u("Адрес","trueSignTokenService.connectionAddress",this.address,I)]}]}),{id:this.id,rows:e}}}function Ce(o,e){return new Ie(o).loadConfig(e).render()}const ve=Object.freeze(Object.defineProperty({__proto__:null,default:Ce},Symbol.toStringTag,{value:"Module"}));class $e{constructor(e){this.id=e,this.SETTINGS_ID="timeoutsSettings",this.LABELS={title:"Таймауты",cdnLoadTimeout:"Загрузка списка cdn, сек",checkRequestTimeout:"Проверка марки в ЧЗ, сек",checkInternetConnectionTimeout:"Проверка доступа в интернет, сек"}}loadConfig(e){return e!=null&&e.httpRequestTimeouts&&(this.cdnLoadTimeout=e.httpRequestTimeouts.cdnRequestTimeout,this.checkRequestTimeout=e.httpRequestTimeouts.checkMarkRequestTimeout,this.checkInternetConnectionTimeout=e.httpRequestTimeouts.checkInternetConnectionTimeout),this}render(){var e=[];return e.push(d("lTimeoutConfig",this.LABELS.title)),e.push({padding:c,rows:[b(this.LABELS.cdnLoadTimeout,"httpRequestTimeouts.cdnRequestTimeout",this.cdnLoadTimeout,"1111"),b(this.LABELS.checkRequestTimeout,"httpRequestTimeouts.checkMarkRequestTimeout",this.checkRequestTimeout,"1111"),b(this.LABELS.checkInternetConnectionTimeout,"httpRequestTimeouts.checkInternetConnectionTimeout",this.checkInternetConnectionTimeout,"1111")]}),{id:this.id,rows:e}}}function Pe(o,e){return new $e(o).loadConfig(e).render()}const Be=Object.freeze(Object.defineProperty({__proto__:null,default:Pe},Symbol.toStringTag,{value:"Module"}));class De{constructor(e){B(this,"LOG_LEVELS",["Verbose","Debug","Information","Warning","Error","Fatal"]);this.id=e,this.SETTINGS_ID="loggingSettings",this.LABELS={title:"Логирование",enabled:"Использовать",depth:"Сколько дней хранить файлы лога",level:"Уровень логирования"}}loadConfig(e){return e!=null&&e.logging&&(this.enabled=e.logging.isEnabled,this.level=e.logging.logLevel,this.depth=e.logging.logDepth),this}render(){var e=[];return e.push(d("lLoggingConfig",this.LABELS.title)),e.push({padding:c,rows:[m(this.LABELS.enabled,"logging.isEnabled",{value:this.enabled,on:{onChange:t=>{t?$$(this.SETTINGS_ID).enable():$$(this.SETTINGS_ID).disable()}}}),{id:this.SETTINGS_ID,disabled:!this.enabled,rows:[b(this.LABELS.depth,"logging.logDepth",this.depth,"1111"),{view:"select",label:this.LABELS.level,labelPosition:"top",id:"LogLevel",name:"logging.logLevel",options:this.LOG_LEVELS,value:this.level}]}]}),{id:this.id,rows:e}}}function Oe(o,e){return new De(o).loadConfig(e).render()}const Ne=Object.freeze(Object.defineProperty({__proto__:null,default:Oe},Symbol.toStringTag,{value:"Module"}));class Re{constructor(e){this.id=e,this.SETTINGS_ID="autoUpdateSettings",this.LABELS={title:"Автоматическое обновление",enabled:"Использовать",catalog:"Каталог с файлами обновления",hours:"Часы для автоматического обновления",fileNameDescription:"служба ищет в указанном каталоге архив update.zip",timeIntervalDescription:"если правая граница интервала 23:59, то ставьте значение 00"},this.HOURS_COUNT=24,this.TIME_COMBO_WIDTH=60}createHoursOptions(){return Array.from({length:this.HOURS_COUNT},(e,t)=>({id:t+1,value:t.toString().padStart(2,"0")}))}timeComboBox(e,t,s=1){return{view:"combo",id:e,name:t,value:s,options:this.createHoursOptions(),maxWidth:this.TIME_COMBO_WIDTH,format:"02",newValues:!1}}loadConfig(e){var i,r;if(e!=null&&e.autoUpdate){this.enabled=e.autoUpdate.enabled??!1,this.updateFilesCatalog=e.autoUpdate.updateFilesCatalog??"";var t=parseInt((i=e==null?void 0:e.autoUpdate)==null?void 0:i.fromHour);t=t<=0?1:t;var s=parseInt((r=e==null?void 0:e.autoUpdate)==null?void 0:r.untilHour);s=s<=0?24:s,this.fromHour=t-1||0,this.untilHour=s-1||0}return this}render(){var e=[];return e.push(d("lAutoUpdateLabel",this.LABELS.title)),e.push({padding:c,rows:[m(this.LABELS.enabled,"autoUpdate.enabled",{value:this.enabled,on:{onChange:t=>{t?$$(this.SETTINGS_ID).enable():$$(this.SETTINGS_ID).disable()}}}),{id:this.SETTINGS_ID,disabled:!this.enabled,rows:[u(this.LABELS.catalog,"autoUpdate.updateFilesCatalog",this.updateFilesCatalog,pe),d("fileNameDescription",this.LABELS.fileNameDescription,{css:{"font-style":"italic","font-size":"smaller"}}),d("lAutoUpdateHours",this.LABELS.hours),{padding:{left:20},cols:[this.timeComboBox("fromHour","autoUpdate.fromHour",this.fromHour+1),d("AutoUpdateTimeSeparator","-",{maxWidth:5}),this.timeComboBox("untilHour","autoUpdate.untilHour",this.untilHour+1),{}]},d("timeIntervalDescription",this.LABELS.timeIntervalDescription,{css:{"font-style":"italic","font-size":"smaller"}})]}]}),{id:this.id,rows:e}}}function ke(o,e){return new Re(o).loadConfig(e).render()}const xe=Object.freeze(Object.defineProperty({__proto__:null,default:ke},Symbol.toStringTag,{value:"Module"}))})();
